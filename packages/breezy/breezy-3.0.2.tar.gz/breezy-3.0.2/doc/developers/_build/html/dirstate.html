
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Dirstate &#8212; Breezy 3.0.2dev documentation</title>
    <link rel="stylesheet" href="_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>

    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Miscellaneous notes" href="miscellaneous-notes.html" />
<link rel="stylesheet" href="_static/brz-doc.css" type="text/css" />
 
  </head><body>
    <div class="header-wrapper" role="banner">
      <div class="header">
        <div class="headertitle"><a
          href="index.html">Developer Document Catalog (3.0.2dev)</a></div>
        <div class="rel" role="navigation" aria-label="related navigation">
          <a href="miscellaneous-notes.html" title="Miscellaneous notes"
             accesskey="P">previous</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="dirstate">
<h1>Dirstate<a class="headerlink" href="#dirstate" title="Permalink to this headline">¶</a></h1>
<p>Don’t really need the hashes of the current versions - just knowing
whether they’ve changed or not will generally be enough - and just the
mtime and ctime of a point in time may be enough?</p>
<div class="section" id="dirblock-state">
<h2><code class="docutils literal notranslate"><span class="pre">_dirblock_state</span></code><a class="headerlink" href="#dirblock-state" title="Permalink to this headline">¶</a></h2>
<p>There are currently 4 levels that state can have.</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>NOT_IN_MEMORY
The actual content blocks have not been read at all.</p></li>
<li><p>IN_MEMORY_UNMODIFIED
The content blocks have been read and are available for use. They have
not been changed at all versus what was written on disk when we read
them.</p></li>
<li><p>IN_MEMORY_HASH_MODIFIED
We have updated the in-memory state, but only to record the
sha1/symlink target value and the stat value that means this
information is ‘fresh’.</p></li>
<li><p>IN_MEMORY_MODIFIED
We have updated an actual record. (Parent lists, added a new file,
deleted something, etc.) In this state, we must always write out the
dirstate, or some user action will be lost.</p></li>
</ol>
</div></blockquote>
<div class="section" id="in-memory-hash-modified">
<h3>IN_MEMORY_HASH_MODIFIED<a class="headerlink" href="#in-memory-hash-modified" title="Permalink to this headline">¶</a></h3>
<p>This state is a bit special, so deserves its own topic.  If we are
IN_MEMORY_HASH_MODIFIED, we only write out the dirstate if enough records
have been updated. The idea is that if we would save future I/O by writing
an updated dirstate, then we should do so. The threshold for this is set
by “worth_saving_limit”. The default is that at least 10 entries must be
updated in order to consider the dirstate file worth updating.</p>
<p>Going one step further, newly added files, symlinks, and directory entries
updates are treated specially. We know that we will always stat all
entries in the tree so that we can observe <em>if</em> they have changed. In the
case of directories, all the information we know about them is just from
that stat value. There is no extra content to read. So an update directory
entry doesn’t cause us to update to IN_MEMORY_HASH_MODIFIED. However, if
there are other modifications worth saving, we will go ahead and save the
directory entry update at the same time.</p>
<p>Similarly, symlink targets are commonly stored in the inode entry
directly. So once we have stat’ed the symlink, we already have its target
information in memory. The one caveat is if we used to think an object was
a file, and it became a directory or symlink, then we will treat it as
worth saving.</p>
<p>In the case of newly added files, we never have to read their content to
know that they are different from the basis tree. So saving the updated
information also won’t save a future read.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table of Contents</h3>
          <ul>
<li class="toctree-l1"><a class="reference internal" href="contribution-quickstart.html">Contributing to Breezy</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="profiling.html">Profiling</a></li>
<li class="toctree-l1"><a class="reference internal" href="bug-handling.html">Tracking Bugs in Breezy</a></li>
<li class="toctree-l1"><a class="reference internal" href="HACKING.html">Breezy Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Breezy Testing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="code-review.html">Reviewing proposed changes to Breezy</a></li>
<li class="toctree-l1"><a class="reference internal" href="code-style.html">Breezy Code Style Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="documenting-changes.html">Documenting Changes</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuring Breezy</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html#breezy-conf">breezy.conf</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html#location-conf">location.conf</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html#branch-conf">branch.conf</a></li>
<li class="toctree-l1"><a class="reference internal" href="fetch.html">Fetching data</a></li>
<li class="toctree-l1"><a class="reference internal" href="transports.html">Developer guide to breezy transports</a></li>
<li class="toctree-l1"><a class="reference internal" href="ui.html">Interacting with the user</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="releasing.html">Releasing Breezy</a></li>
<li class="toctree-l1"><a class="reference internal" href="ppa.html">Managing the Breezy PPA</a></li>
<li class="toctree-l1"><a class="reference internal" href="ec2.html">Breezy Windows EC2 Server</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Breezy Architectural Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="integration.html">Integrating with Breezy</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="principles.html">Breezy Design Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="specifications.html">Specifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="implementation-notes.html">Implementation notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="miscellaneous-notes.html">Miscellaneous notes</a></li>
</ul>

          <div role="search">
            <h3 style="margin-top: 1.5em;">Search</h3>
            <form class="search" action="search.html" method="get">
                <input type="text" name="q" />
                <input type="submit" value="Go" />
            </form>
          </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <div role="navigation" aria-label="related navigaton">
            <a href="miscellaneous-notes.html" title="Miscellaneous notes"
              >previous</a>
          </div>
          <div role="note" aria-label="source link">
              <br/>
              <a href="_sources/dirstate.txt"
                rel="nofollow">Show Source</a>
          </div>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
        &#169; Copyright 2009-2011 Canonical Ltd, 2017-2018 Breezy Developers.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.1.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>