
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>diff Performance Analysis &#8212; Breezy 3.0.2dev documentation</title>
    <link rel="stylesheet" href="../../_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>

    <link rel="search" title="Search" href="../../search.html" />
<link rel="stylesheet" href="_static/brz-doc.css" type="text/css" />
 
  </head><body>
    <div class="header-wrapper" role="banner">
      <div class="header">
        <div class="headertitle"><a
          href="../../index.html">Developer Document Catalog (3.0.2dev)</a></div>
        <div class="rel" role="navigation" aria-label="related navigation">
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="diff-performance-analysis">
<h1>diff Performance Analysis<a class="headerlink" href="#diff-performance-analysis" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#minimal-work" id="id1">Minimal Work</a></p>
<ul>
<li><p><a class="reference internal" href="#reuse-of-historical-comparisons" id="id2">Reuse of historical comparisons</a></p></li>
<li><p><a class="reference internal" href="#historical-tree-against-historical-tree" id="id3">Historical Tree Against Historical Tree</a></p></li>
<li><p><a class="reference internal" href="#basis-against-historical-tree" id="id4">Basis Against Historical Tree</a></p></li>
<li><p><a class="reference internal" href="#basis-against-basis" id="id5">Basis Against Basis</a></p></li>
<li><p><a class="reference internal" href="#working-tree-against-basis" id="id6">Working Tree Against Basis</a></p></li>
<li><p><a class="reference internal" href="#working-tree-against-historical-tree" id="id7">Working Tree Against Historical Tree</a></p></li>
<li><p><a class="reference internal" href="#working-tree-against-working-tree" id="id8">Working Tree Against Working Tree</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#api-changes" id="id9">API Changes</a></p></li>
<li><p><a class="reference internal" href="#storage-considerations" id="id10">Storage considerations</a></p></li>
</ul>
</div>
<div class="section" id="minimal-work">
<h2><a class="toc-backref" href="#id1">Minimal Work</a><a class="headerlink" href="#minimal-work" title="Permalink to this headline">¶</a></h2>
<div class="section" id="reuse-of-historical-comparisons">
<h3><a class="toc-backref" href="#id2">Reuse of historical comparisons</a><a class="headerlink" href="#reuse-of-historical-comparisons" title="Permalink to this headline">¶</a></h3>
<p>A significant part of the work done by diff is sequence matching.  This
scales O(n^2) with the number of lines in the file.  Therefore, it
is worthwile to avoid content comparisons as much as possible.</p>
<p>Our current knit format contains content comparisons, and this data can
be converted into lists of matching blocks.  Other future formats such as
mpdiff may also support such conversion.  So it is possible to reuse past
comparisons.</p>
<p>It is also possible to combine sequential comparisons.  So given a comparison
of “foo” to “bar”, and “bar” to “baz”, it is possible to derive a comparison of
“foo” to “baz”.</p>
<p>Reuse of historical comparisons will scale with the number of uncommon
build-parents between the two historical revisions.  This will typically be
proportional to the amount of change that the file has undergone.  Therefore,
in the common case, reuse of historical comparisons will scale with the
amount of change.</p>
<p>The downside of such reuse is that it ties the comparison to the historical
data.  But given the performance improvement, it seems to be worth
consideration.  Fresh comparisons can be performed if the user requests them.</p>
<p>It may also be possible to accelerate comparisons by including annotation data,
thus increasing the number of unique lines.</p>
</div>
<div class="section" id="historical-tree-against-historical-tree">
<h3><a class="toc-backref" href="#id3">Historical Tree Against Historical Tree</a><a class="headerlink" href="#historical-tree-against-historical-tree" title="Permalink to this headline">¶</a></h3>
<p>This operation should be strictly proportional to the amount of change, because
a comparison has already been done at commit time.  Achieving that performance
requires the committed data to be properly structured, so that the comparison
can be extracted and combined with other comparisons.  This comparision
extraction should be possible at the inventory and file-content levels.</p>
<p>Minimum work:</p>
<ol class="arabic simple">
<li><p>Extract and combine inventory comparisons</p></li>
<li><p>Extract and combine text comparisions for modified texts</p></li>
</ol>
</div>
<div class="section" id="basis-against-historical-tree">
<h3><a class="toc-backref" href="#id4">Basis Against Historical Tree</a><a class="headerlink" href="#basis-against-historical-tree" title="Permalink to this headline">¶</a></h3>
<p>This is another case of Historical Tree Against Historical Tree.</p>
</div>
<div class="section" id="basis-against-basis">
<h3><a class="toc-backref" href="#id5">Basis Against Basis</a><a class="headerlink" href="#basis-against-basis" title="Permalink to this headline">¶</a></h3>
<p>This is another case of Historical Tree Against Historical Tree.</p>
</div>
<div class="section" id="working-tree-against-basis">
<h3><a class="toc-backref" href="#id6">Working Tree Against Basis</a><a class="headerlink" href="#working-tree-against-basis" title="Permalink to this headline">¶</a></h3>
<p>This must scale with the number of versioned files, unless the user indicates
that only certain files should be compared.</p>
<p>Performance can be further improved by caching comparisons to avoid repeating
them.  Caching could potentially be performed by <code class="docutils literal notranslate"><span class="pre">diff</span></code> and perhaps by
<code class="docutils literal notranslate"><span class="pre">merge</span></code>.  Merge is aware of the relationship of a text merge’s result to
the THIS value, and the THIS value is generally the basis value.  So the
comparison is latent, but present.  The only issue is extracting it.</p>
<p>The cache could be indexed by sha1sum pairs.  It could also be indexed by
file-id, to facilitate removal of stale data.</p>
<p>Minimum work:</p>
<ol class="arabic simple">
<li><p>Scan working tree for modified files</p></li>
<li><p>Retrieve cached comparisons</p></li>
<li><p>Perform comparisons on files with no cached comparisons</p></li>
<li><p>Cache comparisons for files with no cached comparisons</p></li>
</ol>
</div>
<div class="section" id="working-tree-against-historical-tree">
<h3><a class="toc-backref" href="#id7">Working Tree Against Historical Tree</a><a class="headerlink" href="#working-tree-against-historical-tree" title="Permalink to this headline">¶</a></h3>
<p>This can be structured as a comparison of working tree against basis tree,
followed by basis tree against historical tree.  Therefore, it combines the
performance characteristics of “Working Tree Against Basis” with “Basis Against
Historical Tree”.</p>
</div>
<div class="section" id="working-tree-against-working-tree">
<h3><a class="toc-backref" href="#id8">Working Tree Against Working Tree</a><a class="headerlink" href="#working-tree-against-working-tree" title="Permalink to this headline">¶</a></h3>
<p>This can be structured as two comparisons against basis, and one comparison
of basis against basis.  Its performance is therefore similar to Working Tree
Against Historical Tree.</p>
</div>
</div>
<div class="section" id="api-changes">
<h2><a class="toc-backref" href="#id9">API Changes</a><a class="headerlink" href="#api-changes" title="Permalink to this headline">¶</a></h2>
<p>Desired API:</p>
<blockquote>
<div><ul class="simple">
<li><p>Tree.get_comparision(file_id, tree)</p></li>
</ul>
</div></blockquote>
<p>This probably entails:</p>
<blockquote>
<div><ul class="simple">
<li><p>WorkingTree.store_comparison(file_id, revision_id, sha1, comparison)</p></li>
<li><p>WorkingTree.get_comparison(file_id, revision_id, sha1)</p></li>
<li><p>Repository.get_comparision(file_id, revision_id, revision_id)</p></li>
<li><p>merge_comparisions(comparison, comparision)</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="storage-considerations">
<h2><a class="toc-backref" href="#id10">Storage considerations</a><a class="headerlink" href="#storage-considerations" title="Permalink to this headline">¶</a></h2>
<p>It must be cheap (e.g. scale with number of intermediate revisions) to perform
comparison of two historical texts.  It must be cheap to perform comparison of
the inventories of two historical trees.</p>
</div>
</div>


          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table of Contents</h3>
          <ul>
<li class="toctree-l1"><a class="reference internal" href="../../contribution-quickstart.html">Contributing to Breezy</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../profiling.html">Profiling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bug-handling.html">Tracking Bugs in Breezy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../HACKING.html">Breezy Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing.html">Breezy Testing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code-review.html">Reviewing proposed changes to Breezy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code-style.html">Breezy Code Style Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documenting-changes.html">Documenting Changes</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuring Breezy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html#breezy-conf">breezy.conf</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html#location-conf">location.conf</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html#branch-conf">branch.conf</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fetch.html">Fetching data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../transports.html">Developer guide to breezy transports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ui.html">Interacting with the user</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../releasing.html">Releasing Breezy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ppa.html">Managing the Breezy PPA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ec2.html">Breezy Windows EC2 Server</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Breezy Architectural Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../integration.html">Integrating with Breezy</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../principles.html">Breezy Design Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../specifications.html">Specifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../implementation-notes.html">Implementation notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../miscellaneous-notes.html">Miscellaneous notes</a></li>
</ul>

          <div role="search">
            <h3 style="margin-top: 1.5em;">Search</h3>
            <form class="search" action="../../search.html" method="get">
                <input type="text" name="q" />
                <input type="submit" value="Go" />
            </form>
          </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <div role="navigation" aria-label="related navigaton">
          </div>
          <div role="note" aria-label="source link">
              <br/>
              <a href="../../_sources/plans/performance/diff.txt"
                rel="nofollow">Show Source</a>
          </div>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
        &#169; Copyright 2009-2011 Canonical Ltd, 2017-2018 Breezy Developers.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.1.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>