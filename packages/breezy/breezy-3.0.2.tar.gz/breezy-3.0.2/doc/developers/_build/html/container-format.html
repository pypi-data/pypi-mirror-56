
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Container format &#8212; Breezy 3.0.2dev documentation</title>
    <link rel="stylesheet" href="_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>

    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Overview" href="groupcompress-design.html" />
    <link rel="prev" title="Bundles" href="bundles.html" />
<link rel="stylesheet" href="_static/brz-doc.css" type="text/css" />
 
  </head><body>
    <div class="header-wrapper" role="banner">
      <div class="header">
        <div class="headertitle"><a
          href="index.html">Developer Document Catalog (3.0.2dev)</a></div>
        <div class="rel" role="navigation" aria-label="related navigation">
          <a href="bundles.html" title="Bundles"
             accesskey="P">previous</a> |
          <a href="groupcompress-design.html" title="Overview"
             accesskey="N">next</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="container-format">
<h1><a class="toc-backref" href="#id3">Container format</a><a class="headerlink" href="#container-format" title="Permalink to this headline">¶</a></h1>
<div class="section" id="status">
<h2><a class="toc-backref" href="#id4">Status</a><a class="headerlink" href="#status" title="Permalink to this headline">¶</a></h2>
<dl class="field-list simple">
<dt class="field-odd">Date</dt>
<dd class="field-odd"><p>2007-06-07</p>
</dd>
</dl>
<p>This document describes the proposed container format for streaming and
storing collections of data in Bazaar.  Initially this will be used for
streaming revision data for incremental push/pull in the smart server for
0.18, but the intention is that this will be the basis for much more
than just that use case.</p>
<p>In particular, this document currently focuses almost exclusively on the
streaming case, and not the on-disk storage case.  It also does not
discuss the APIs used to manipulate containers and their records.</p>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#container-format" id="id3">Container format</a></p>
<ul>
<li><p><a class="reference internal" href="#status" id="id4">Status</a></p></li>
<li><p><a class="reference internal" href="#motivation" id="id5">Motivation</a></p></li>
<li><p><a class="reference internal" href="#terminology" id="id6">Terminology</a></p></li>
<li><p><a class="reference internal" href="#use-cases" id="id7">Use Cases</a></p>
<ul>
<li><p><a class="reference internal" href="#streaming-data-between-a-smart-server-and-client" id="id8">Streaming data between a smart server and client</a></p>
<ul>
<li><p><a class="reference internal" href="#incremental-push-or-pull" id="id9">Incremental push or pull</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#persistent-storage-on-disk" id="id10">Persistent storage on disk</a></p></li>
<li><p><a class="reference internal" href="#usable-before-deep-model-changes-to-bazaar" id="id11">Usable before deep model changes to Bazaar</a></p></li>
<li><p><a class="reference internal" href="#examples-of-possible-record-content" id="id12">Examples of possible record content</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#characteristics" id="id13">Characteristics</a></p>
<ul>
<li><p><a class="reference internal" href="#no-length-prefixing-of-entire-container" id="id14">No length-prefixing of entire container</a></p></li>
<li><p><a class="reference internal" href="#structured-as-a-self-contained-series-of-records" id="id15">Structured as a self-contained series of records</a></p></li>
<li><p><a class="reference internal" href="#addressing-records" id="id16">Addressing records</a></p></li>
<li><p><a class="reference internal" href="#reasonably-cheap-for-small-records" id="id17">Reasonably cheap for small records</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#specification" id="id18">Specification</a></p>
<ul>
<li><p><a class="reference internal" href="#record-types" id="id19">Record types</a></p>
<ul>
<li><p><a class="reference internal" href="#end-marker" id="id20">End Marker</a></p></li>
<li><p><a class="reference internal" href="#bytes" id="id21">Bytes</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#names" id="id22">Names</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="motivation">
<h2><a class="toc-backref" href="#id5">Motivation</a><a class="headerlink" href="#motivation" title="Permalink to this headline">¶</a></h2>
<p>To create a low-level file format which is suitable for solving the smart
server latency problem and whose layout and requirements are extendable in
future versions of Bazaar, and with no requirements that the smart server
does not have today.</p>
</div>
<div class="section" id="terminology">
<h2><a class="toc-backref" href="#id6">Terminology</a><a class="headerlink" href="#terminology" title="Permalink to this headline">¶</a></h2>
<p>A <strong>container</strong> is a streamable file that contains a series of
<strong>records</strong>.  Records may have <strong>names</strong>, and consist of bytes.</p>
</div>
<div class="section" id="use-cases">
<h2><a class="toc-backref" href="#id7">Use Cases</a><a class="headerlink" href="#use-cases" title="Permalink to this headline">¶</a></h2>
<p>Here’s a brief description of use cases this format is intended to
support.</p>
<div class="section" id="streaming-data-between-a-smart-server-and-client">
<h3><a class="toc-backref" href="#id8">Streaming data between a smart server and client</a><a class="headerlink" href="#streaming-data-between-a-smart-server-and-client" title="Permalink to this headline">¶</a></h3>
<p>It would be nice if we could combine multiple containers into a single
stream by something no more expensive than concatenation (e.g. by omitting
end/start marker pairs).</p>
<p>This doesn’t imply that such a combination necessarily produces a valid
container (e.g. care must be taken to ensure that names are still unique
in the combined container), or even a useful container.  It is simply that
the cost of assembling a new combined container is practically as cheap as
simple concatenation.</p>
<div class="section" id="incremental-push-or-pull">
<h4><a class="toc-backref" href="#id9">Incremental push or pull</a><a class="headerlink" href="#incremental-push-or-pull" title="Permalink to this headline">¶</a></h4>
<p>Consider the use case of incremental push/pull, which is currently (0.16)
very slow on high-latency links due to the large number of round trips.
What we’d like is something like the following.</p>
<p>A client will make a request meaning “give me the knit contents for these
revision IDs” (how the client determines which revision IDs it needs is
unimportant here).  In response, the server streams a single container of:</p>
<blockquote>
<div><ul class="simple">
<li><p>one record per file-id:revision-id knit gzip contents and graph data,</p></li>
<li><p>one record per inventory:revision-id knit gzip contents and graph
data,</p></li>
<li><p>one record per revision knit gzip contents,</p></li>
<li><p>one record per revision signature,</p></li>
<li><p>end marker record.</p></li>
</ul>
</div></blockquote>
<p>in that order.</p>
</div>
</div>
<div class="section" id="persistent-storage-on-disk">
<h3><a class="toc-backref" href="#id10">Persistent storage on disk</a><a class="headerlink" href="#persistent-storage-on-disk" title="Permalink to this headline">¶</a></h3>
<p>We want a storage format that allows lock-free writes, which suggests a
format that uses <em>rename into place</em>, and <em>do not modify after writing</em>.</p>
</div>
<div class="section" id="usable-before-deep-model-changes-to-bazaar">
<h3><a class="toc-backref" href="#id11">Usable before deep model changes to Bazaar</a><a class="headerlink" href="#usable-before-deep-model-changes-to-bazaar" title="Permalink to this headline">¶</a></h3>
<p>We want a format we can use and refine sooner rather than later.  So it
should be usable before the anticipated model changes for Bazaar “1.0”
land, while not conflicting with those changes either.</p>
<p>Specifically, we’d like to have this format in Bazaar 0.18.</p>
</div>
<div class="section" id="examples-of-possible-record-content">
<h3><a class="toc-backref" href="#id12">Examples of possible record content</a><a class="headerlink" href="#examples-of-possible-record-content" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>full texts of file versions</p></li>
<li><p>deltas of full texts</p></li>
<li><p>revisions</p></li>
<li><p>inventories</p></li>
<li><p>inventory as tree items e.g. the inventory data for 20 files</p></li>
<li><p>revision signatures</p></li>
<li><p>per-file graph data</p></li>
<li><p>annotation cache</p></li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="characteristics">
<h2><a class="toc-backref" href="#id13">Characteristics</a><a class="headerlink" href="#characteristics" title="Permalink to this headline">¶</a></h2>
<p>Some key aspects of the described format are discussed in this section.</p>
<div class="section" id="no-length-prefixing-of-entire-container">
<h3><a class="toc-backref" href="#id14">No length-prefixing of entire container</a><a class="headerlink" href="#no-length-prefixing-of-entire-container" title="Permalink to this headline">¶</a></h3>
<p>The overall container is not length-prefixed.  Instead there is an end
marker so that readers can determine when they have read the entire
container.  This also does not conflict with the goal of allowing
single-pass writing.</p>
</div>
<div class="section" id="structured-as-a-self-contained-series-of-records">
<h3><a class="toc-backref" href="#id15">Structured as a self-contained series of records</a><a class="headerlink" href="#structured-as-a-self-contained-series-of-records" title="Permalink to this headline">¶</a></h3>
<p>The container contains a series of <em>records</em>.  Each record is
self-delimiting.  Record markers are lightweight.  The overhead in terms
of bytes and processing for records in this container vs. the raw contents
of those records is minimal.</p>
</div>
<div class="section" id="addressing-records">
<h3><a class="toc-backref" href="#id16">Addressing records</a><a class="headerlink" href="#addressing-records" title="Permalink to this headline">¶</a></h3>
<p>There is a requirement that each object can be given an arbitrary name.
Some version control systems address all content by the SHA-1 digest of
that content, but this scheme is unsatisfactory for Bazaar’s revision
objects.  We can still allow addressing by SHA-1 digest for those content
types where it makes sense.</p>
<p>Some proposed object names:</p>
<blockquote>
<div><ul class="simple">
<li><p>to name a revision: “<code class="docutils literal notranslate"><span class="pre">revision:</span></code><em>revision-id</em>”.  e.g.,
<cite>revision:pqm&#64;pqm.ubuntu.com-20070531210833-8ptk86ocu822hjd5</cite>.</p></li>
<li><p>to name an inventory delta: “<code class="docutils literal notranslate"><span class="pre">inventory.delta:</span></code><em>revision-id</em>”.  e.g.,
<cite>inventory.delta:pqm&#64;pqm.ubuntu.com-20070531210833-8ptk86ocu822hjd5</cite>.</p></li>
</ul>
</div></blockquote>
<p>It seems likely that we may want to have multiple names for an object.
This format allows that (by allowing multiple <code class="docutils literal notranslate"><span class="pre">name</span></code> headers in a Bytes
record).</p>
<p>Although records are in principle addressable by name, this specification
alone doesn’t provide for efficient access to a particular record given
its name.  It is intended that separate indexes will be maintained to
provide this.</p>
<p>It is acceptable to have records with no explicit name, if the expected
use of them does not require them.  For example:</p>
<blockquote>
<div><ul class="simple">
<li><p>a record’s content could be self-describing in the context of a
particular container, or</p></li>
<li><p>a record could be accessed via an index based on SHA-1, or</p></li>
<li><p>when streaming, the first record could be treated specially.</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="reasonably-cheap-for-small-records">
<h3><a class="toc-backref" href="#id17">Reasonably cheap for small records</a><a class="headerlink" href="#reasonably-cheap-for-small-records" title="Permalink to this headline">¶</a></h3>
<p>The overhead for storing fairly short records (tens of bytes, rather than
thousands or millions) is minimal.  The minimum overhead is 3 bytes plus
the length of the decimal representation of the <em>length</em> value (for a
record with no name).</p>
</div>
</div>
<div class="section" id="specification">
<h2><a class="toc-backref" href="#id18">Specification</a><a class="headerlink" href="#specification" title="Permalink to this headline">¶</a></h2>
<p>This describes just a basic layer for storing a simple series of
“records”.  This layer has no intrinsic understanding of the contents of
those records.</p>
<p>The format is:</p>
<blockquote>
<div><ul class="simple">
<li><p>a <strong>container lead-in</strong>, “<code class="docutils literal notranslate"><span class="pre">Bazaar</span> <span class="pre">pack</span> <span class="pre">format</span> <span class="pre">1</span> <span class="pre">(introduced</span> <span class="pre">in</span> <span class="pre">0.18)\n</span></code>”,</p></li>
<li><p>followed by one or more <strong>records</strong>.</p></li>
</ul>
</div></blockquote>
<p>A record is:</p>
<blockquote>
<div><ul class="simple">
<li><p>a 1 byte <strong>kind marker</strong>.</p></li>
<li><p>0 or more bytes of record content, depending on the record type.</p></li>
</ul>
</div></blockquote>
<div class="section" id="record-types">
<h3><a class="toc-backref" href="#id19">Record types</a><a class="headerlink" href="#record-types" title="Permalink to this headline">¶</a></h3>
<div class="section" id="end-marker">
<h4><a class="toc-backref" href="#id20">End Marker</a><a class="headerlink" href="#end-marker" title="Permalink to this headline">¶</a></h4>
<p>An <strong>End Marker</strong> record:</p>
<blockquote>
<div><ul class="simple">
<li><p>has a kind marker of “<code class="docutils literal notranslate"><span class="pre">E</span></code>”,</p></li>
<li><p>no content bytes.</p></li>
</ul>
</div></blockquote>
<p>End Marker records signal the end of a container.</p>
</div>
<div class="section" id="bytes">
<h4><a class="toc-backref" href="#id21">Bytes</a><a class="headerlink" href="#bytes" title="Permalink to this headline">¶</a></h4>
<p>A <strong>Bytes</strong> record:</p>
<blockquote>
<div><ul>
<li><p>has a kind marker of “<code class="docutils literal notranslate"><span class="pre">B</span></code>”,</p></li>
<li><p>followed by a mandatory <strong>content length</strong> <a class="footnote-reference brackets" href="#id2" id="id1">1</a>:
“<em>number</em><code class="docutils literal notranslate"><span class="pre">\n</span></code>”, where <em>number</em> is in decimal, e.g:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1234</span>
</pre></div>
</div>
</li>
<li><p>followed by zero or more optional <strong>names</strong>:
“<em>name</em><code class="docutils literal notranslate"><span class="pre">\n</span></code>”, e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">revision</span><span class="p">:</span><span class="n">pqm</span><span class="nd">@pqm</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span><span class="o">-</span><span class="mi">20070531210833</span><span class="o">-</span><span class="mi">8</span><span class="n">ptk86ocu822hjd5</span>
</pre></div>
</div>
</li>
<li><p>followed by an <strong>end of headers</strong> byte: “<code class="docutils literal notranslate"><span class="pre">\n</span></code>”,</p></li>
<li><p>followed by some <strong>bytes</strong>, exactly as many as specified by the length
prefix header.</p></li>
</ul>
</div></blockquote>
<p>So a Bytes record is a series of lines encoding the length and names (if
any) followed by a body.</p>
<p>For example, this is a possible Bytes record (including the kind marker):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">B26</span>
<span class="n">example</span><span class="o">-</span><span class="n">name1</span>
<span class="n">example</span><span class="o">-</span><span class="n">name2</span>

<span class="n">abcdefghijklmnopqrstuvwxyz</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="names">
<h3><a class="toc-backref" href="#id22">Names</a><a class="headerlink" href="#names" title="Permalink to this headline">¶</a></h3>
<p>Names should be UTF-8 encoded strings, with no whitespace.  Names should
be unique within a single container, but no guarantee of uniqueness
outside of the container is made by this layer.  Names need to be at least
one character long.</p>
<dl class="footnote brackets">
<dt class="label" id="id2"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>This requires that the writer of a record knows the full length of
the record up front, which typically means it will need to buffer an
entire record in memory.  For the first version of this format this is
considered to be acceptable.</p>
</dd>
</dl>
</div>
</div>
</div>


          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table of Contents</h3>
          <ul>
<li class="toctree-l1"><a class="reference internal" href="contribution-quickstart.html">Contributing to Breezy</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="profiling.html">Profiling</a></li>
<li class="toctree-l1"><a class="reference internal" href="bug-handling.html">Tracking Bugs in Breezy</a></li>
<li class="toctree-l1"><a class="reference internal" href="HACKING.html">Breezy Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Breezy Testing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="code-review.html">Reviewing proposed changes to Breezy</a></li>
<li class="toctree-l1"><a class="reference internal" href="code-style.html">Breezy Code Style Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="documenting-changes.html">Documenting Changes</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuring Breezy</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html#breezy-conf">breezy.conf</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html#location-conf">location.conf</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html#branch-conf">branch.conf</a></li>
<li class="toctree-l1"><a class="reference internal" href="fetch.html">Fetching data</a></li>
<li class="toctree-l1"><a class="reference internal" href="transports.html">Developer guide to breezy transports</a></li>
<li class="toctree-l1"><a class="reference internal" href="ui.html">Interacting with the user</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="releasing.html">Releasing Breezy</a></li>
<li class="toctree-l1"><a class="reference internal" href="ppa.html">Managing the Breezy PPA</a></li>
<li class="toctree-l1"><a class="reference internal" href="ec2.html">Breezy Windows EC2 Server</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Breezy Architectural Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="integration.html">Integrating with Breezy</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="principles.html">Breezy Design Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="specifications.html">Specifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="implementation-notes.html">Implementation notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="miscellaneous-notes.html">Miscellaneous notes</a></li>
</ul>

          <div role="search">
            <h3 style="margin-top: 1.5em;">Search</h3>
            <form class="search" action="search.html" method="get">
                <input type="text" name="q" />
                <input type="submit" value="Go" />
            </form>
          </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <div role="navigation" aria-label="related navigaton">
            <a href="bundles.html" title="Bundles"
              >previous</a> |
            <a href="groupcompress-design.html" title="Overview"
              >next</a>
          </div>
          <div role="note" aria-label="source link">
              <br/>
              <a href="_sources/container-format.txt"
                rel="nofollow">Show Source</a>
          </div>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
        &#169; Copyright 2009-2011 Canonical Ltd, 2017-2018 Breezy Developers.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.1.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>